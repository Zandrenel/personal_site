version: 2.1

jobs:
  runner-test:
    machine: true
    steps:
      - run: echo "Hi I'm on Runners!"
  ssh_deploy:
    machine:
      image: ubuntu-2204:2023.07.2
    steps:
      - run:
          name: Plan a deploy
          command: |
            circleci run release plan \
            --environment-name="pi deployment" \
            --component-name="first" \
            --target-version="1.0.0"
      # Your job here doing the actual deployment
      - run:
          name: Deploy Over SSH
          command: |
            ssh $SSH_USER@$SSH_HOST "cd /var/www/personal_site && git pull && systemctl restart site"
      - run:
          name: Update a deploy to SUCCESS
          command: circleci run release update --status=SUCCESS 
          when: on_success 
      - run:
          name: Update planned deploy to FAILED
          command: circleci run release update --status=FAILED 
          when: on_fail	    

workflows:
  testing:
    jobs:
      - runner-test
  deploy:
    jobs:
      - ssh_deploy:
         filters:
           branches:
             only: master # only deploy on the main branch
