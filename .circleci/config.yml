version: 2.1

jobs:
  run-tests:
    docker:
      - image: swipl:stable
    steps:
      - checkout
      - run:
          name: Download FFMPEG
          command: |
            RUN apt-get update && \
            apt-get install -y --no-install-recommends \
            ffmpeg && \
            rm -rf /var/lib/apt/lists/*
      - run:
          name: Check env
          command: |
            ls -la
            swipl --version
      - run:
          name: Run Tests
          command: |
            swipl -g "tests." server.pl  

  ssh_deploy:
    machine:
      image: default
    steps:
      - run:
          name: Plan a deploy
          command: |
            circleci run release plan \
            --environment-name="pi deployment" \
            --component-name="personal_site" \
            --target-version="1.0.1"
      # Your job here doing the actual deployment
      - add_ssh_keys:
          fingerprints:
            - "6c:ec:a9:42:4a:06:05:44:c6:f2:e5:66:ba:9e:97:97"
      - run:
          name: Deploy Over SSH
          command: |
            ssh $SSH_USER@$SSH_HOST "cd /var/www/personal_site && git pull && echo '$SSH_PASS' | sudo -S chmod 665 ./scripts/* && echo '$SSH_PASS' | sudo -S ./scripts/prod-deploy-docker.sh"
      - run:
          name: Update a deploy to SUCCESS
          command: circleci run release update --status=SUCCESS 
          when: on_success 
      - run:
          name: Update planned deploy to FAILED
          command: circleci run release update --status=FAILED 
          when: on_fail	    

workflows:
  testing:
    jobs:
      - run-tests:
          filters:
            branches:
              ignore: master
    
  test-deploy:
    jobs:
      - run-tests
      - ssh_deploy:
         requires:
           - run-tests
         filters:
           branches:
             only: master # only deploy on the main branch
